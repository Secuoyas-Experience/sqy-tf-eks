name: Push main
on:
  push:
    branches:
      - main
  workflow_dispatch:
  
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
  
jobs:
  TerraformPlan:
    runs-on: ubuntu-latest
    steps:
      - name: Git clone the repository
        uses: actions/checkout@v4
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::756537058243:role/GriddoGithubCanExecTF_role
          role-session-name: terraformPlanning
          aws-region: eu-central-1
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.5.7
      - name: TF init
        run: terraform init
      - name: TF check
        run: terraform fmt -check
      - name: TF validate
        run: terraform validate
      - name: TF plan
        run: terraform plan
      - name: TF apply
        run: terraform apply -auto-approve
